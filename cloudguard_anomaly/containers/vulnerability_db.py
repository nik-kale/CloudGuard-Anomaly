"""
Vulnerability database for container scanning.

Provides offline CVE database and severity mappings.
"""

import logging
from typing import Dict, Optional, List
from dataclasses import dataclass

logger = logging.getLogger(__name__)


@dataclass
class CVEInfo:
    """CVE information."""
    cve_id: str
    severity: str
    cvss_score: float
    description: str
    affected_packages: List[str]
    fixed_versions: Dict[str, str]


class VulnerabilityDatabase:
    """
    Offline vulnerability database for container scanning.

    Provides CVE information and severity mappings when
    online scanning tools are not available.
    """

    def __init__(self):
        """Initialize vulnerability database."""
        self.cve_data: Dict[str, CVEInfo] = {}
        self._load_known_cves()
        logger.info("Vulnerability database initialized")

    def _load_known_cves(self):
        """Load known high-severity CVEs."""
        # Sample of well-known CVEs for offline detection
        # Production should use a regularly updated CVE database

        known_cves = [
            CVEInfo(
                cve_id='CVE-2021-44228',
                severity='critical',
                cvss_score=10.0,
                description='Log4Shell - Remote Code Execution in Log4j',
                affected_packages=['log4j', 'log4j-core'],
                fixed_versions={'log4j': '2.17.0', 'log4j-core': '2.17.0'}
            ),
            CVEInfo(
                cve_id='CVE-2022-0492',
                severity='high',
                cvss_score=7.8,
                description='Linux kernel cgroups vulnerability',
                affected_packages=['linux-kernel'],
                fixed_versions={'linux-kernel': '5.16.2'}
            ),
            CVEInfo(
                cve_id='CVE-2021-3156',
                severity='high',
                cvss_score=7.8,
                description='Sudo heap buffer overflow (Baron Samedit)',
                affected_packages=['sudo'],
                fixed_versions={'sudo': '1.9.5p2'}
            ),
            CVEInfo(
                cve_id='CVE-2022-24765',
                severity='high',
                cvss_score=7.8,
                description='Git arbitrary configuration injection',
                affected_packages=['git'],
                fixed_versions={'git': '2.35.2'}
            ),
            CVEInfo(
                cve_id='CVE-2021-33909',
                severity='high',
                cvss_score=7.8,
                description='Sequoia - Linux kernel filesystem vulnerability',
                affected_packages=['linux-kernel'],
                fixed_versions={'linux-kernel': '5.13.4'}
            ),
        ]

        for cve in known_cves:
            self.cve_data[cve.cve_id] = cve

    def get_cve(self, cve_id: str) -> Optional[CVEInfo]:
        """Get CVE information."""
        return self.cve_data.get(cve_id)

    def get_severity(self, cve_id: str) -> str:
        """Get CVE severity."""
        cve = self.get_cve(cve_id)
        return cve.severity if cve else 'unknown'

    def get_cvss_score(self, cve_id: str) -> Optional[float]:
        """Get CVSS score."""
        cve = self.get_cve(cve_id)
        return cve.cvss_score if cve else None

    def check_package(self, package: str, version: str) -> List[CVEInfo]:
        """Check if a package version is vulnerable."""
        vulnerabilities = []

        for cve in self.cve_data.values():
            if package in cve.affected_packages:
                # Simple version check (production should use proper version comparison)
                fixed_version = cve.fixed_versions.get(package)
                if fixed_version and version < fixed_version:
                    vulnerabilities.append(cve)

        return vulnerabilities

    def get_statistics(self) -> Dict[str, int]:
        """Get database statistics."""
        stats = {
            'total_cves': len(self.cve_data),
            'critical': 0,
            'high': 0,
            'medium': 0,
            'low': 0
        }

        for cve in self.cve_data.values():
            severity = cve.severity.lower()
            if severity in stats:
                stats[severity] += 1

        return stats

